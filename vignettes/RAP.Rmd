---
title: "Use of RAP package"
author: "Bart-Jan van Rossum"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: false
    number_sections: true
bibliography: bibliography.bib
vignette: >
  %\VignetteIndexEntry{Use of RAP package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include = FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>",
fig.dim = c(7, 5)
)
library(RAP)
```

# General introduction about package  

TO BE WRITTEN 

----

# Create TD object

The first step when modeling a field trial or performing a GxE analysis using 
the RAP package will always be creating an object of class TD. Such an object
is used internally by the package for performing all types of analysis.  

A TD object can be easily created from a data.frame by calling the function
`createTD`. This function will do a several things:  
* Rename columns to default column names used by the RAP package. For example, 
the column in the data containing variety/accession/genotype will allways be 
renamed to genotype. Original column names will be stored as an attribute to 
the final object of class TD.  
* Convert column type to the default column types. For example the column 
genotype will always be converted to a factor and rowCoord will always be 
converted to a numeric column.  
* Split the data by trial. The output TD object will be a list of data.frames
where each data.frame contains the data for a single trial. If there is only 
one trial or no column trial is defined the output will be a list with one
item only.  
* Add meta data to the seperate data.frames in the TD object. This meta data 
consists of location, date, longitude, latitude, plot design, width and length.
None of this is strictly neccessary for doing analysis but it is used for 
plotting field layouts, plotting trials on a map and naming plots. For a single 
trial can simply be added when creating the TD object using the function 
parameters in `createTD`. However if the data consists of multiple trials with
different meta data per trial it is more convenient to first create a TD object
without using the parameters for adding meta data. Doing so only a location will
be added based on the name of the trial. After creating the TD object the meta
data can be extracted using `getMeta`. This function outputs a data.frame with 
the meta data per trial. The content of this data.frame can then be modified 
and added back to the TD object using `setMeta`.  

After creating a TD object data for new trials can be added to it using 
`addTD`. This function works in exactly the same way as `createTD` except that
it adds data to an existing TD object instead of creating a new one. Still the
output needs to be assigned to a variable.  

As an example we will create a TD object using field data from an experiment
with wheat in Chili described by @Lado2013. This data will be used as an 
example throughout this vignette.  

The experiment was performed in two locations with 2 different drought regimes 
in two years for the first location and 1 trial for the second location. For the
sake of the example we will create an TD object for the first location first and
add the data for the second location later on. In practice this could also be 
done in one go.
```{r createTD}
data("wheatChl")
wheatTD <- createTD(data = wheatChl[wheatChl$trial != "C_SWS_12", ], 
                    genotype = "trt_id", repId = "rep", subBlock = "bl", 
                    rowId = "row", colId = "col", rowCoord = "row", 
                    colCoord = "col")
```
Note that both row and col are used twice. This is done since whenever a spatial
model is fitted both a factor column containing the spatial information and a
numeric column containing this information are needed. `rowId` and `colId` will 
be converted to a factor and `rowCoord` and `colCoord` will remain numerical 
column as they were in the input.  

The TD object we just created will be a list with 4 items, 1 for each trial 
(combination of location, drought regime and year) in the original data.frame. 
The meta data will be a data.frame with 4 rows.
```{r getMeta}
wheatMeta <- getMeta(TD = wheatTD)
head(wheatMeta)
```

Now we can modify the meta data and then add it back to the original TD object.
```{r setMeta}
wheatMeta$trLocation <- "Santa Rosa"
wheatMeta$trDate <- as.Date(rep(c("310811", "310812"), times = 2), "%d%m%y")
wheatMeta$trLat <- -36.32
wheatMeta$trLong <- -71.55
wheatMeta$trPlotWidth = 2
wheatMeta$trPlotLength = 1
wheatTD <- setMeta(TD = wheatTD, meta = wheatMeta)
```

To add the final trial to the TD object the function `addTD` can be used. Since
in this case we are only adding 1 new trial it makes sense to immediately add 
the meta data for this trial as well. 
```{r addTD}
wheatTD <- addTD(TD = wheatTD, data = wheatChl[wheatChl$trial == "C_SWS_12", ], 
                 genotype = "trt_id", repId = "rep", subBlock = "bl", 
                 rowId = "row", colId = "col", rowCoord = "row", 
                 colCoord = "col", trLocation = "Cauquenes", 
                 trDate = as.Date("070712", "%d%m%y"), trLat = -35.58,
                 trLong = -72.17, trPlotWidth = 2, trPlotLength = 1)
## Inspect the meta data after the extra trial was added.
getMeta(TD = wheatTD)
```

To get an idea of the content of the data and the field layout of the data we 
can summarize and plot the TD object. Multiple traits can be summarized at once 
but in order to save space we only look at GY (grain yield).
```{r TDsum}
summary(wheatTD, trial = "SR_FI_11", traits = "GY")
```

```{r layoutPlot}
plot(wheatTD, trials = "SR_FI_11")
```

The default plot creates plots for the layout of all trials in the TD object.
This can be restricted to selected trials using the `trials` parameter. The 
width and length of the plot will be derived from the trPlotWidth and 
trPlotLength in the meta data if these are available.  

A second type of plot will plot the trial locations on a map. This plot is made
based on trLat and trLong in the meta data. If not available the corresponding
location will not be plotted.
```{r mapPlot}
plot(wheatTD, plotType = "map")
```

----

# Modeling

After creating a TD object the next step will usually be fitting a model on
the trial data. This can be done using the function `STRunModel`. Depending on 
the design of the trial several different models can be fitted. The design can 
be given as a parameter in the function or can be included in the meta data of 
the TD object. In the first case the same model will be fitted for all trials, 
in the latter case different models can be fitted for different trials 
depending on the design. If both are available the function parameter will 
always be leading. 

All models can be fitted using 3 different model fitting engines, 
SpATS [@RodAlv2017], lme4 [@Bates2015] and asreml [@Gilmour2009]. For models 
with rowcol or res.rowcol design SpATS is the default engine, for the other 
models lme4. This can be overruled by the function parameter `engine`.

The exact models fitted are the following  
* ibd trait = genotype + *subBlock* + e  
* res.ibd trait = genotype + **repId** + **repId:subBlock** + e  
* rcbd trait = genotype + **repId** + e  
* rowcol trait = genotype + *rowId* + *colId* + e  
* res.rowcol trait = genotype + **repId** + *repId:rowId* + *repId:colId* + e  

In the models above fixed effects are indicated in *italics* whereas random 
effects are indicated in **bold**. genotype will be fitted as fixed or as 
random effect, or both, depending on the value of the parameter `what`. Extra
fixed effects may be fitted using the parameter `covariates`.  
In case SpATS is used as engine for fitting models an extra spatial term is 
always included in the model. The same is done when the engine is asreml and 
the function parameter `trySpatial` is set to true.

Using the TD object wheatTD we created in the previous section we can now fit 
a model on the data. 
```{r fitSp, message=FALSE}
modWheat <- STRunModel(TD = wheatTD, trials = "SR_FI_11", traits = "GY",
                       design = "res.rowcol")
```
Note that by not supplying the `what` argument to the function two models will
be fitted, one with genotype as a fixed effect and one with genotype as a 
random effect. Because of this both BLUEs and BLUPs can be calculated from 
the output and this will be done when summarizing the results. If genotype 
would have been fitted as fixed effect only, the summary would only have 
contained BLUEs. When fitting genotype as random effect only the summary would 
only have contained the BLUPs.
```{r fitSum, message=FALSE}
## Set nBest to 5 to decrease size of output.
summary(modWheat, nBest = 5)
```

## Model plots

Two types of plots can be made based on the fitted model. The first is a series
of 4 plots, a histogram of the residuals, normal quantiles of the residuals, 
a scatter plot of residuals against fitted values and a scatter plot of absolute
value of residuals against fitted values. These plots can be made by calling 
plot on the SSA object. A plot will always be made for 1 trait in 1 trial for
1 fitted model, either with genotype as fixed or genotype as random effect. If
only 1 trait and/or trial were used for fitting the model these are 
automatically used for plotting. Otherwise use the parameters `trait` and 
`trial` for selecting. If only one model is fitted, i.e. only genotype as fixed
effect or only genotype as random effect, the results of this model will be 
plotted. In case both models were fitted as a default the results will be 
plotted for the model with genotype fixed. This can be changed using the 
parameter `what`.
```{r basePlot}
plot(modWheat, what = "random")
```

The second type of plot consists of 5 plots, spatial plots of the raw data, 
fitted values, residuals and either BLUEs or BLUPs, and a histogram of the BLUEs 
or BLUPs. In case SpATS was used as modeling engine an extra plot an extra plot
with the fitted spatial trend is included. The call for creating these plots 
differs from the base plots only by an extra parameter `plotType = "spatial"`. 
```{r spatPlot}
plot(modWheat, plotType = "spatial")
```

## Model reports

As with many object in the RAP package there is a report function available for
SSA objects. This `report` function will create a pdf report describing the 
main results of the fitted model. Also a tex file will be created that was used 
for generating the pdf report. By editing the tex file it is possible to modify
the report to ones needs.  

When no outfile is given a report will be created with a default name in the 
current working directory. The parameter `outfile` can be used to change this. 
This value of this parameter should be a valid location and name for a **pdf**
file. Non existing directories will be created by the reporting function.  

The report will contain some background information on the model fitted, a 
summary of the results, the plots described in the previous section, a list of
best (highest BLUEs or BLUPs) genotypes and a scatter plot of all genotypes
and their BLUEs or BLUPs. If for the modeled trait a low value means the 
genotype is performing well then the best genotypes can be based on the lowest
BLUEs or BLUPs by setting `descending` to `TRUE` when calling the report 
function.
```{r modRep, eval=FALSE}
## Create a report in the current working directory
report(modWheat)
## Create a report for the model with genotype fitted as random.
report(modWheat, outfile = "./myReports/wheatReport.pdf", what = "random")
```
Similar to plotting a SSA object reporting is also done for 1 trait in 1 trial 
for 1 fitted model. Selection of the model to report is done in the same way 
as for plotting described in the previous section. Parameters `trait`, `trial`
and `what` can be used for this.

----

# Extract 

After fitting a model various results can be extracted or calculated from the 
fitted model using the function `STExtract`. This can be a single result for 1 
trait and 1 trial or a list of different results for all models in a SSA object. 
The results that can be extracted depend on the type of model fitted and 
sometimes on the engine as well. BLUEs can only extracted is genotype was fitted 
as fixed effect whereas BLUPs and heritabilities can only be extracted and 
calculated if genotype was fitted as random effect.  
All results that can be extracted are shown in the table below. The first column
shows what model needs to be fitted in order to be able to extract the result.
F stands for genotype as fixed effect, R for genotype as random effect. In the 
second column is the result. This is also the value to be used for the parameter
`what` in `STExtract`. The last column gives a short description of the result
that will be extracted and where needed also states for which modeling engines 
it can be extracted.

model | result | description |
----- | ------ | ------------------------------------------------------------- |
F | BLUEs | Best Lineair Unbiased Estimators |
F | seBLUES | standard errors of the BLUEs |
R | BLUPs | Best Lineair Unbiased Predictors |
R | seBLUPs | standard errors of the BLUPs |
F | ue | unit errors - only for `lme4` and `asreml` |
R | heritability | broad sense heritability |
R | varGen | genetic variance component |
R | varErr | residual variance component - only for `lme4` and `asreml` |
R | varSpat | spatial variance components - only for `SpATS` |
F | fitted | fitted values for the model with genotype as fixed component |
F | resid | residuals for the model with genotype as fixed component |
F | stdRes | standardized residuals for the model with genotype as fixed component - only for `lme4` and `asreml` |
R | rMeans | fitted values for the model with genotype as random component |
R | ranEf | random genetic effects |
F | wald | results of the wald test - only for `lme4` and `asreml` |
F | CV | Coefficient of variation - only for `lme4` and `asreml` |
F | rDf | residual degrees of freedom |
R | effDim | effective dimensions - only for `SpATS` |
F | sed | standard error of difference - only for `asreml` |
F | lsd | least significant difference - only for `asreml` |

Using `what = "all"` in the function call extracts all results possible for the
fitted model. This is also the default.  

Some examples of extracting results from a fitted model. Recall that `modWheat`
contains 2 fitted models, 1 with genotype as fixed effect and 1 with genotype as
random effect.
```{r extBLUEs}
## Extract BLUEs
BLUEsWheat <- STExtract(SSA = modWheat, what = "BLUEs")
## Extract BLUEs and BLUPs
predWheat <- STExtract(SSA = modWheat, what = c("BLUEs", "BLUPs"))
```
Both `BLUEsWheat` and `predWheat` are a list with 1 item, the trial used for
modeling. In general there will be an item in the list for every trial for 
which results were extracted. However where the item in `BLUEsWheat` is a 
data.frame containing the BLUEs `predWheat` itself is again a list with 2 items,
the data.frames BLUEs and BLUPs. Looking at the data.frame BLUEs in either of 
the list it only consists of 2 columns, genotype and GY. In case the model 
would have been fitted for multiple traits all these traits would become columns
in the data.frame. It might be useful to add extra information to the output. 
This can be achieved using the paramater `keep` in `STExtract`. If we would 
like to include the trial for example so later on we can easily combine the
several data.frames with BLUEs and use the for a GxE analysis this can be done
like this.
```{r extBLUEsKeep}
BLUEsWheat2 <- STExtract(SSA = modWheat, what = "BLUEs", keep = "trial")
```
Not every column from the original TD object can be included in the extracted 
data in this way. Only column for which the values are uniform per genotype can 
be included. For example the column repId that usually has several different 
values for a single genotype cannot be included. When trying to do so it will be
dropped with a warning.  


----

# References


