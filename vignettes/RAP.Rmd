---
title: "Modeling field trials using RAP"
author: "Bart-Jan van Rossum"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: false
    number_sections: true
bibliography: bibliography.bib
vignette: >
  %\VignetteIndexEntry{Modeling field trials using RAP}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r setup, include = FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>",
fig.dim = c(7, 5)
)
library(RAP)
```

# The RAP Package  

The RAP package is developed as an easy to use package for analysing data of 
plant breeding experiments with plenty of options for plotting and reporting 
the results of the analyses.  

The package has 3 main components:

* Modeling trial data for single trials and extracting results
* Genotype by Environment (GxE) analysis
* QTL analysis

This vignette deals with the modeling part of the package and describes in 
detail how to prepare data for analysis, perform analysis using different
modeling engines and extract the results from the models.

----

# Data preparation

The first step when modeling field trial data or performing a GxE analysis with 
the RAP package is creating an object of class `TD`. This object is used by the 
RAP package for performing most analyses.  

## Creating a `TD` object

A `TD` object can be created from a `data.frame` with the function `createTD`. 
This function does a number of things:  

* Rename columns to default column names used by the RAP package. For example, 
the column in the data containing variety/accession/genotype is renamed to 
`genotype`. Original column names are stored as an attribute of the `TD` object.
* Convert column type to the default column types. For example the column 
genotype is converted to a factor and rowCoord to a numeric column.
* Split the data into separate data.frames by trial. The output `TD` object is a
`list` of `data.frames` where each `data.frame` contains the data for a single
trial. If there is only one trial or no column trial is defined the output will 
be a `list` with only one item.
* Add meta data to the separate `data.frames` in the `TD` object. The meta data 
consists of location, date of the experiment, longitude, latitude, trial design,
plot width and plot length. None of these is strictly neccessary for any 
analysis but the meta data is used for plotting field layouts, plotting trials 
on a map and naming plots. Meta data for a single trial can simply be added when creating the `TD` object using the parameters in `createTD`. However if the data consists of multiple trials with different meta data per trial it is more 
convenient to first create a `TD` object without adding meta data. This will 
still add a location based on the name of the trial. After creating the `TD` 
object the meta data can then be extracted using `getMeta`. This function 
outputs a `data.frame` with the meta data per trial. The content of this 
`data.frame` can then be modified and added back to the `TD` object using 
`setMeta`.  

After creating a `TD` object data for new trials can be added to it using 
`addTD`. This function works in exactly the same way as `createTD` except that
it adds data to an existing `TD` object instead of creating a new one.  
Dropping one or more trials from a `TD` object can be done using the function
`dropTD` specifying the trials to drop in the parameter `trials`.

## Example

Field data from an experiment with wheat in Chili described in detail by 
@Lado2013 will be used as an example throughout this vignette. The experiment 
was performed in 2 locations in Chili with 2 different drought regimes in 2011
and 2012 for the first location and 1 trial in 2012 for the second location. For
384 genotypes 4 traits were measured in 2011 but in 2012 only grain yield (GY) 
was measured and the examples will mainly focus on this trait.  

For the example first a `TD` object is created for the first location and 
the data for the second location is then added later on. In practice all this
could be done in one go.
```{r createTD}
data("wheatChl")
wheatTD <- createTD(data = wheatChl[wheatChl$trial != "C_SWS_12", ], 
                    genotype = "trt_id", repId = "rep", subBlock = "bl", 
                    rowId = "row", colId = "col", rowCoord = "row", 
                    colCoord = "col")
```
Note that both "row" and "col" are used twice as input columns. This is done 
since whenever a spatial model is fitted both a factor column containing the 
spatial information and a numeric column containing this information are needed. `rowId` and `colId` are converted to a factor and `rowCoord` and `colCoord` 
remain numerical columns as they were in the input.  

The `TD` object just created is a `list` with 4 items, 1 for each trial 
(combination of location, drought regime and year) in the original `data.frame`. 

## Meta data

The meta data will be a `data.frame` with 4 rows, 1 for each item in `wheatTD`.
```{r getMeta}
(wheatMeta <- getMeta(TD = wheatTD))
```

After extracting the meta data it can be modified and then added it back to the original `TD` object.
```{r setMeta}
wheatMeta$trLocation <- "Santa Rosa"
wheatMeta$trDate <- as.Date(rep(c("310811", "310812"), times = 2), "%d%m%y")
wheatMeta$trLat <- -36.32
wheatMeta$trLong <- -71.55
wheatMeta$trPlWidth = 2
wheatMeta$trPlLength = 1
wheatTD <- setMeta(TD = wheatTD, meta = wheatMeta)
```

## Add extra data to a `TD` object

To add the data for the final trial to the `TD` object the function `addTD` can
be used. Since now 1 new trial is added it makes sense to immediately add the 
meta data for this trial as well using the appropriate parameters in `addTD`. 
```{r addTD, R.options=list(width=90)}
wheatTD <- addTD(TD = wheatTD, data = wheatChl[wheatChl$trial == "C_SWS_12", ], 
                 genotype = "trt_id", repId = "rep", subBlock = "bl", 
                 rowId = "row", colId = "col", rowCoord = "row", 
                 colCoord = "col", trLocation = "Cauquenes", 
                 trDate = as.Date("070912", "%d%m%y"), trLat = -35.58,
                 trLong = -72.17, trPlWidth = 2, trPlLength = 1)
## Inspect the meta data after the extra trial was added.
getMeta(TD = wheatTD)
```

## Summarising a `TD` object

Use the `summary` function to get an idea of the content of the data in the `TD` object. Multiple traits may be summarised at once but for clarity a summary is
only made for GY.
```{r TDsum}
summary(wheatTD, trial = "SR_FI_11", traits = "GY")
```

Using the default options 9 summary statistics are printed, but many more are 
available. These can be accessed using the parameter `what` in the `summary`
function. For a full list of available statistics use `help(summary.TD)`. It is 
also possible to output all statistics using `what = "all"`.

## Plotting a `TD` object

The default plot creates plots for the layout of all trials in the `TD` object.
This can be restricted to selected trials using the `trials` parameter. The 
width and length of the plot are derived from the trPlWidth and trPlLength in 
the meta data if these are available.  
```{r layoutPlot}
plot(wheatTD, trials = "SR_FI_11")
```

A second type of plot displays the trial locations on a map. This plot is 
made based on trLat and trLong in the meta data. If not available the 
corresponding location is not plotted.
```{r mapPlot}
plot(wheatTD, plotType = "map")
```

----

# Modeling

After creating a `TD` object the next step usually is fitting a model on
the trial data. This is done using the function `STRunModel`. Depending on 
the design of the trial several different models can be fitted. The design can 
be given as a parameter in the function or included in the meta data of 
the `TD` object. In the former case the same model will be fitted for all 
trials, in the latter different models can be fitted for different trials 
depending on the design. If both are available the function parameter will 
always be leading. 

The output of `STRunModel` is an object of class `SSA` (Single Site Analysis), a
`list` of fitted models with 1 item for each trial the model was fitted for. 

## Model types

`STRunModel` uses 3 different engines for fitting the models, namely
SpATS [@RodAlv2017], lme4 [@Bates2015] and asreml [@Gilmour2009]. For models 
with rowcol or res.rowcol design SpATS is the default engine, for the other 
models lme4. This can always be overruled by specifying the function 
parameter `engine`.

At the moment of writing models can be fitted for 5 different trial designs. 
These are listed in the following table with their respective specifications.  

design | model fitted |
------- | -------------------------------------------------------------------- |
ibd | trait = genotype + *subBlock* + $\epsilon$ |
res.ibd | trait = genotype + **repId** + **repId:subBlock** + $\epsilon$ |
rcbd | trait = genotype + **repId** + $\epsilon$ | 
rowcol | trait = genotype + *rowId* + *colId* + $\epsilon$ |
res.rowcol | trait = genotype + **repId** + *repId:rowId* + *repId:colId* + $\epsilon$ |

In the models above fixed effects are indicated in *italics* whereas random 
effects are indicated in **bold**. genotype can be fitted as fixed or as 
random effect depending on the value of the parameter `what`. Extra
fixed effects may be fitted using the parameter `covariates`.  
If SpATS is used as modeling engine an extra spatial term is always 
included in the model. The same is done when the engine is asreml and 
the function parameter `trySpatial` is set to true.

Using the `TD` object wheatTD from the previous section a model for the trial 
SR_FI_11 and trait GY can now be fitted on the data as follows. For the design
of the trial a residual row column design is assumed. Since `engine` is not 
supplied as a parameter SpATS is used for fitting the model.
```{r fitSp, message=FALSE}
modWheatSp <- STRunModel(TD = wheatTD, trials = "SR_FI_11", traits = "GY",
                         design = "res.rowcol")
```
Note that by not supplying the `what` argument to the function two models are
fitted, one with genotype as a fixed effect and one with genotype as a 
random effect. The results of both these models are stored in the `SSA` object
`modWheatSp`. This is very useful for extracting different results from the 
model later on. A trade off is that fitting 2 models takes more time than 
fitting only 1 so when fitting models on large datasets it is sensible to use 
`what` if only some results are needed as output.
```{r fitSpSm, message=FALSE}
## Fit a single trial model with genotype as random effect.
modWheatSp2 <- STRunModel(TD = wheatTD, trials = "SR_FI_11", traits = "GY",
                          what = "random", design = "res.rowcol")
```

## Spatial models

When using SpATS as a modeling engine for fitting a model an extra spatial 
component is always included in the model. This spatial component is composed
using the `PSANOVA` function in the SpATS package which uses 2-dimensional 
smoothing with P-splines as described in @Lee2013. See `help(PSANOVA, SpATS)`
for a detailed description. The parameters `nseg` and `nest.div` of `PSANOVA` 
can be modified using the `control` parameter in `STRunModel`.  
Refitting the model in the previous section specifying the number of segments
for both rows and columns as 20 works as follows
```{r fitSpCtr, message=FALSE}
modWheatSp3 <- STRunModel(TD = wheatTD, trials = "SR_FI_11", traits = "GY",
                          design = "res.rowcol", 
                          control = list(nSeg = c(20, 20)))
```

Alternatively, spatial models can be fitted using asreml as modeling engine 
and setting the parameter `trySpatial = TRUE` . In this case 6 models are fitted 
and the best model, based on a goodness-of-fit criterion, either AIC or BIC, is 
chosen. For a full specification of the models fitted see `help(STRunModel)`. 
The criterion to be used can be specified using the `control` parameter in `STRunModel`.  
Fitting a model similar to the one above using asreml with BIC as 
goodness-of-fit criterion works as follows
```{r fitAs, message=FALSE, results='hide'}
if (requireNamespace("asreml")) {
  modWheatAs <- STRunModel(TD = wheatTD, trials = "SR_FI_11", traits = "GY",
                           design = "res.rowcol", trySpatial = TRUE,
                           engine = "asreml", control = list(criterion = "BIC"))
}
```
The chosen model is stored in the output:
```{r spatCh}
modWheatAs$SR_FI_11$spatial
```

## Model output

Since genotype has been fitted both as fixed and as random factor in 
`modWheatSp` it is possible to calculate both Best Lineair Unbiased Estimators 
(BLUEs) and Best Lineair Unbiased Predictors (BLUPs). Therefore both are printed 
in the summary of the model together with their respective standard errors.
```{r fitSum, message=FALSE}
## Set nBest to 5 to decrease size of output.
summary(modWheatSp, nBest = 5)
```

## Model plots

2 Types of plots can be made based on the fitted model. The first is a series
of 4 plots, a histogram of the residuals, normal quantiles of the residuals, 
a scatter plot of residuals against fitted values and a scatter plot of absolute
value of residuals against fitted values. These plots can be made by calling 
`plot` on the `SSA` object. A plot will always be made for 1 trait in 1 trial 
for 1 fitted model, either the model with genotype as fixed effect or the model 
with genotype as random effect. If only 1 trait and/or trial were used for 
fitting the model these are automatically used for plotting. Otherwise use the parameters `trait` and `trial` for selecting the proper trait and trial to be 
plotted. If only one model is fitted, i.e. only the model with genotype as fixed
effect or only the model with genotype as random effect, the results of this 
model will be plotted. In case both models were fitted as a default the results 
will be plotted for the model with genotype fixed. This can be changed using the 
parameter `what`.
```{r basePlot}
## Plot for the model with genotype fitted as random effect.
plot(modWheatSp, what = "random")
```

The second type of plot consists of 5 plots, spatial plots of the raw data, 
fitted values, residuals and either BLUEs or BLUPs, and a histogram of the BLUEs 
or BLUPs. If SpATS was used as modeling engine an extra plot with the fitted 
spatial trend is included. The call for creating these plots differs from the 
base plots only by an extra parameter `plotType = "spatial"`. 
```{r spatPlot}
## Spatial plot for the model with genotype fitted as fixed effect.
plot(modWheatSp, plotType = "spatial")
```

## Model reports

As with many objects in the RAP package there is a `report` function available 
for `SSA` objects. This `report` function creates a pdf report describing 
the main results of the fitted model. Also the tex file is saved that was 
used for generating the pdf report. By editing the tex file it is possible to 
modify the report to ones needs creating high flexibility.  

When no outfile is given a report will be created with a default name in the 
current working directory. The parameter `outfile` can be used to change this. 
This value of this parameter should be a valid location and name for a **pdf**
file, i.e. including the postfix ".pdf". Non-existing directories are be created 
by the `report` function.  

The report contains general information on the model fitted, a 
summary of the results, the plots described in the previous section, a `list` of
best (highest BLUEs or BLUPs) genotypes and a scatter plot of all genotypes
and their BLUEs or BLUPs. If for the modeled trait a low value means the 
genotype is performing well then the selection on the best genotypes can be 
based on the lowest BLUEs or BLUPs by setting `descending` to `TRUE` when 
calling the report function.
```{r modRep, eval=FALSE}
## Create a report in the current working directory
report(modWheatSp)
## Create a report for the model with genotype fitted as random.
report(modWheatSp, outfile = "./myReports/wheatReport.pdf", what = "random")
```
Similar to plotting an `SSA` object reporting is also done for 1 trait in 1 
trial for 1 fitted model. Selection of the model to report is done in the same 
way as for plotting described in the previous section. Parameters `trait`, 
`trial` and `what` can be used for this.

----

# Extracting model results

After fitting a model various results can be extracted or calculated from the 
fitted model using the function `STExtract`. This can be anything from a single 
result for 1 trait and 1 trial to a `list` of different results for all models 
in an `SSA` object. The results that can be extracted depend on the type of 
model fitted and sometimes on the modeling engine as well. For example, BLUEs 
can only extracted if genotype was fitted as fixed effect whereas BLUPs and heritabilities can only be extracted and calculated if genotype was fitted as 
random effect.  

## Possible results to extract

All results that can be extracted are shown in the table below. The first column
shows what model needs to be fitted in order to be able to extract the result.
F stands for genotype as fixed effect, R for genotype as random effect. In the 
second column is the result. This is also the value to be used for the parameter
`what` in `STExtract` needed to extract the corresponding result. The last 
column gives a short description of the result that will be extracted and where
needed also states for which modeling engines it can be extracted.

model | result | description |
----- | ------ | ------------------------------------------------------------- |
F | BLUEs | Best Lineair Unbiased Estimators |
F | seBLUES | standard errors of the BLUEs |
R | BLUPs | Best Lineair Unbiased Predictors |
R | seBLUPs | standard errors of the BLUPs |
F | ue | unit errors - only for `lme4` and `asreml` |
R | heritability | broad sense heritability |
R | varGen | genetic variance component |
R | varErr | residual variance component - only for `lme4` and `asreml` |
R | varSpat | spatial variance components - only for `SpATS` |
F | fitted | fitted values for the model with genotype as fixed component |
F | resid | residuals for the model with genotype as fixed component |
F | stdRes | standardized residuals for the model with genotype as fixed component - only for `lme4` and `asreml` |
R | rMeans | fitted values for the model with genotype as random component |
R | ranEf | random genetic effects |
F | wald | results of the wald test - only for `lme4` and `asreml` |
F | CV | Coefficient of Variation - only for `lme4` and `asreml` |
F | rDf | residual degrees of freedom |
R | effDim | effective dimensions - only for `SpATS` |
F | sed | standard error of difference - only for `asreml` |
F | lsd | least significant difference - only for `asreml` |

Using `what = "all"` in the function call extracts all results possible for the
fitted model. This is also the default.  

Below are some examples of extracting results from a fitted model. Recall that `modWheatSp` contains 2 fitted models, 1 with genotype as fixed effect and 1 with genotype as random effect.
```{r extBLUEs}
## Extract BLUEs
BLUEsWheat <- STExtract(SSA = modWheatSp, what = "BLUEs")
## Extract BLUEs and BLUPs
predWheat <- STExtract(SSA = modWheatSp, what = c("BLUEs", "BLUPs"))
```
Both `BLUEsWheat` and `predWheat` are a `list` with 1 item, the trial used for
modeling. In general there will be an item in the `list` for every trial for 
which results were extracted. However where the item in `BLUEsWheat` is a 
`data.frame` containing the BLUEs `predWheat` itself is again a `list` with 2 
items, the `data.frames` containing BLUEs and BLUPs respectively. 

## Adding extra variables

The `data.frame` BLUEs in either of the `lists` consists of only 2 columns, 
genotype and GY. If the model would have been fitted for multiple traits all 
these traits would become columns in the `data.frame`. It might be useful to add
extra columns from the data used to fit the model to the output. This can be 
achieved using the paramater `keep` in `STExtract`. To include the trial in the 
output, useful for easily combining several `data.frames` with BLUEs and using
them for a GxE analysis use the following command
```{r extBLUEsKeep}
BLUEsWheat2 <- STExtract(SSA = modWheatSp, what = "BLUEs", keep = "trial")
head(BLUEsWheat2[[1]])
```
Not every column from the original `TD` object can be included in the extracted 
data in this way. Only columns for which the values are uniform per genotype can 
be included. For example the column `repId` containing replicates that usually 
has several different values for a single genotype cannot be included. 
When trying to do so it will be dropped with a warning.  
It is however possible to include `repId` when extracting fitted values since 
for each observation in the original data a fitted value is returned. 
```{r extFit}
fitVals <- STExtract(SSA = modWheatSp, what = "fitted", 
                     keep = c("trial", "repId"))
head(fitVals[[1]])
```

----

# References


