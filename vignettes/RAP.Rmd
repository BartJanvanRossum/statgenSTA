---
title: "Use of RAP package"
author: "Bart-Jan van Rossum"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: bibliography.bib
vignette: >
  %\VignetteIndexEntry{Use of RAP package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(RAP)
```

General introduction about package

## Create TD object

The first step when modeling a field trial or performing a GxE analysis using 
the RAP package will always be creating an object of class TD. Such an object
is used internally by the package for performing all types of analysis.  

A TD object can be easily created from a data.frame by calling the function
`createTD`. This function will do a several things:  
* Rename columns to default column names used by the RAP package. For example, 
the column in the data containing variety/accession/genotype will allways be 
renamed to genotype. Original column names will be stored as an attribute to 
the final object of class TD.  
* Convert column type to the default column types. For example the column 
genotype will always be converted to a factor and rowCoord will always be 
converted to a numeric column.  
* Split the data by trial. The output TD object will be a list of data.frames
where each data.frame contains the data for a single trial. If there is only 
one trial or no column trial is defined the output will be a list with one
item only.  
* Add meta data to the seperate data.frames in the TD object. This meta data 
consists of location, date, longitude, latitude, plot design, width and length.
None of this is strictly neccessary for doing analysis but it is used for 
plotting field layouts, plotting trials on a map and naming plots. For a single 
trial can simply be added when creating the TD object using the function 
parameters in `createTD`. However if the data consists of multiple trials with
different meta data per trial it is more convenient to first create a TD object
without using the parameters for adding meta data. Doing so only a location will
be added based on the name of the trial. After creating the TD object the meta
data can be extracted using `getMeta`. This function outputs a data.frame with 
the meta data per trial. The content of this data.frame can then be modified 
and added back to the TD object using `setMeta`.  

After creating a TD object data for new trials can be added to it using 
`addTD`. This function works in exactly the same way as `createTD` except that
it adds data to an existing TD object instead of creating a new one. Still the
output needs to be assigned to a variable.  
  
As an example we will create a TD object using field data from an experiment
with wheat in Australia in 2008-2009. This data will be used as an example
throughout this vignette.

```{r createTD}
data("wheatAus")
wheatTD <- createTD(data = wheatAus, genotype = "geno", trial = "Trial",
                    repId = "rep", rowId = "row", colId = "col", 
                    rowCoord = "row", colCoord = "col")
```
Note that both row and col are used twice. This is done since whenever a spatial
model is fitted both a factor column containing the spatial information and a
numeric column containing this information are needed. `rowId` and `colId` will 
be converted to a factor and `rowCoord` and `colCoord` will remain numerical 
column as they were in the input.  

The TD object we just created will be a list with 14 items, 1 for each trial in
the original data.frame. The meta data will be a data.frame with 14 rows.
```{r getMeta}
wheatMeta <- getMeta(TD = wheatTD)
head(wheatMeta)
```

Now we can modify the meta data and then add it back to the original TD object.
```{r setMeta}
wheatMeta$trDate <- rep(as.Date(c("01/03/08", "01/03/09"), "%d/%m/%y"), each = 7)
wheatMeta$trLat <- -33.8688
wheatMeta$trLong <- 151.2093
wheatTD <- setMeta(TD = wheatTD, meta = wheatMeta)
```

To get an idea of the content of the data and the field layout of the data we 
can summarize and plot the TD object. 
```{r TDsum}
summary(wheatTD, trial = "08CM", traits = "yield")
```

```{r layoutPlot}
plot(wheatTD, trials = "08CM")
```

The default plot creates plots for the layout of all trials in the TD object.
This can be restricted to selected trials using the `trials` parameter. The 
width and length of the plot will be derived from the trPlotWidth and 
trPlotLength in the meta data if these are available.  

A second type of plot will plot the trial locations on a map. This plot is made
based on trLat and trLong in the meta data. If not available the corresponding
location will not be plotted.
```{r mapPlot}
plot(wheatTD, plotType = "map")
```

## Modeling

Explanation on how to do basic modeling using a TD object  
$Y = X\beta + \epsilon$  
test[see @Rodrguezlvarez2017]

## Extract 

Explanation on what can be extracted from a model and how

## References


